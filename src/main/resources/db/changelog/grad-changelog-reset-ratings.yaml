databaseChangeLog:
  - changeSet:
      id: 023-recalculate-product-ratings
      author: antigravity
      comment: "Recalculate average_rating and review_count from actual reviews"
      changes:
        - sql:
            sql: |
              UPDATE products p
              SET 
                average_rating = COALESCE((
                  SELECT AVG(r.rating::numeric) 
                  FROM reviews r 
                  WHERE r.product_id = p.id
                ), 0),
                review_count = COALESCE((
                  SELECT COUNT(*) 
                  FROM reviews r 
                  WHERE r.product_id = p.id
                ), 0);
